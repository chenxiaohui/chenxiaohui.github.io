---
title: 变长数组的问题
author: Harry Chen
layout: post

dsq_thread_id:
  - 1291933394
categories:
  - C++
format: standard
---
# 

  今天在gcc里写代码，偶然发现好像下标可以用变量（非const），比如：


    int n=0;
    scanf("%d",&n);
    int a[n];//当然这里一定要有合法性判断


  这个理念太颠覆了，从学c语言的时候就被灌输说数组长度是不可变的，想用可变长度的话，要么malloc一块内存，要么用vector这种动态表。后来试了试发现vc里是直接无法通过编译的。查到如下一段说明：

> 在C99中新加入了对变长数组的支持，即数组的长度可以由某个非const变量来定义。可变数组的空间大小直到程序运行时才能确定，因此只有程序在运行时才能为程序分配空间。在gcc编译器程序会在运行时根据实际指定的大小(变量当前的值)调节esp的值，为数组在栈上分配适当大小的空间。由于要在运行时才能为数组分配空间，在开始分配空间之前空间的大小是不确定的，因此分配空间的起始地址也是不确定的(例如要在栈上分配两个可变长数组的情况下)。为了在以后的代码中对可变长数组的内容进行引用操作，程序必须通过某种方式获取可变长数组的地址。在gcc编译器中会在相对于ebp固定的偏移量的栈上分配的一个固定大小的区域（称为内情向量）来记录可变长数组的信息，如数组的开始地址等。后继代码通过内情向量中的起始地址访问可变长数组。
>
> 因为数组依靠在程序运行时动态的调整esp来分配空间，所以这种类型的数组只能够定义在栈内，不能够定义在数据段上(全局数组，静态数组)。

  看来gcc才是王道啊。
